<html>
    <head>
        <script>
            // We need to tell the router to land this IP address.
            //
            // We can't just make a request to starlinkrouter/, because it will be 
            // blocked by CORS. starlinkrouter/ is not HTTPS, and cannot be HTTPS
            // because the site is hosted on the router.
            //
            // Instead, we redirect to http://starlinkrotuer/landed, which will
            // immediately land the requesting IP address and redirect back to
            // this page with the added query parameter "landed=y".
            function land(referrer) {
                window.location.href = `http://starlinkrouter/landed?referrer=${referrer}`;
            }

            // Starlink landing pages will automatically "land" the client after a 10s timeout,
            // to maintain backwards compatibility with clients that cannot complete the landing page.
            //
            // If the device has loaded this page, disable the 10s timeout. This is an important
            // step for Androids, since once the Android is landed it will close the landing page.
            function viewingLanding(referrer) {
                window.location.href = `http://starlinkrouter/viewing-landing?referrer=${referrer}`;
            }

            // iOS and Android have different landing page behaviors:
            // - iOS: keeps the landing page open until the user clicks "Done" or "Cancel"
            // - Android: closes the landing page as soon as connectivity is detected
            //
            // Our target UX is to keep the landing page open for both clients until
            // the user clicks a button to connect. On iOS this is native via "Done".
            // On Android, the website must implement this button itself!
            //
            // autoland() will automatically land if the client is iOS. 
            function autoland() {
                // The user agent loads pretty quickly, but not right away. Use a timeout
                // loop instead of window.onload() since window.onload() may take a while
                // for larger websites.
                setTimeout(function() {
                    if (navigator == null) {
                        autoland();
                        return;
                    }

                    var userAgent = navigator.userAgent || navigator.veng;
                    if (userAgent == null || userAgent == "") {
                        autoland();
                        return;
                    }

                    if (/AppleWebKit/i.test(userAgent)) {
                        land("ios");
                        return;
                    }

                    viewingLanding("unknown");
                    return;
                }, 500); 
            }

            // Landing state machine, given https://landingpage.com
            // 
            // client loads https://landingpage.com
            // -> iOS? -> redirect to http://starlinkrouter/landing -> client landed, http://starlinkrouter/landing redirects back to https://landingpage.com?landing=landed
            // 
            // -> redirect to http://starlinkrouter/viewing-landing -> http://starlinkrouter/viewing-landing redirects back to https://landingpage.com?landing=viewing
            // ... -> user clicks button -> redirect to http://starlinkrouter/landing-> client landed, redirects back to https://landingpage.com?landing=landed
            if (window.location.search.includes("landing=landed")) {
                window.onload = function() {
                    document.getElementById("landed").style.visibility = "visible";
                };
            } else if (!window.location.search.includes("landing=viewing")) {
                autoland();
            }
        </script>
    </head>
    <body>
        <h1>My Landing Page</h1>
        </br>
        </br>
        <div>
            Landing page? more like takeoff page.
            <button id="connect-button" onclick="land('button')">Connect</button>
            <div id="landed" style="visibility: hidden;">Landed! Cruising altitude.</div>
        </div>
    </body>
</html>